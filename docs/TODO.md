# x402決済ミドルウェア開発 TODOリスト

##意識すべきこと
-各ファイルがどういう役割を担っているかのを把握すること
-各ファイル間の関係・各フォルダ毎の関係を把握すること
-なので新しいファイルを作成し、そこに書くべきコードを提示する場合でもこのファイルにはこういう責務と役割があり、他のファイル or フォルダとはこのような関係があるということを明示してください
## フェーズ1: プロジェクト基盤構築

### 1.1 プロジェクト初期設定
- [ ] モノレポ構成の作成
  - [ ] `/apps/api` - Express/Nest APIサーバー
  - [ ] `/apps/web` - Next.js クライアント
  - [ ] `/packages/x402-mw` - 共通ミドルウェア
  - [ ] `/packages/shared` - 共通型定義
  - [ ] `/infra` - インフラ設定
- [ ] パッケージ管理設定（pnpm workspace）
- [ ] TypeScript設定（共通tsconfig）
- [ ] ESLint/Prettier設定
- [ ] Git設定（.gitignore, pre-commit hooks）

### 1.2 開発環境構築
- [ ] Docker Compose設定
  - [ ] PostgreSQL コンテナ
  - [ ] Redis コンテナ  
  - [ ] API サーバーコンテナ
  - [ ] Web クライアントコンテナ
- [ ] 環境変数管理（.env.example）
- [ ] ヘルスチェックエンドポイント

## フェーズ2: データベース・キャッシュ設計

### 2.1 PostgreSQL設計
- [ ] データベーススキーマ設計
  ```sql
  -- payments テーブル
  -- payment_nonces テーブル  
  -- rate_limits テーブル
  -- audit_logs テーブル（追加提案）
  ```
- [ ] マイグレーション設定（Prisma/Drizzle）
- [ ] インデックス設計・最適化
- [ ] データ保持ポリシー設定

### 2.2 Redis設計
- [ ] レート制限用キー設計
- [ ] nonce管理用TTL設定
- [ ] キャッシュ戦略実装
- [ ] Redis クラスター設定（本番用）

## フェーズ3: x402ミドルウェア実装

### 3.1 コア機能実装
- [x] PaymentRequirements型定義
- [x] PaymentPayload型定義
- [x] 402応答生成機能
- [x] X-PAYMENT ヘッダーパース機能
- [x] リソースバインディング機能

### 3.2 Facilitator連携
- [x] CDP Facilitator API クライアント
- [x] POST /v2/x402/verify 実装
- [x] POST /v2/x402/settle 実装
- [x] エラーハンドリング・リトライ機能
- [x] Circuit Breaker パターン実装

### 3.3 自前検証モード（将来対応）
- [ ] EIP-3009署名検証（viem）
- [ ] チェーン送信機能
- [ ] ガス代計算・管理
- [ ] ネットワーク切り替え対応

## フェーズ4: セキュリティ機能実装

### 4.1 リプレイ防止
- [x] nonce生成・検証機能
- [ ] 有効期限チェック ← 次の実装対象
- [ ] Redis保存・重複チェック ← 次の実装対象  
- [ ] 期限切れnonce自動削除 ← 次の実装対象

### 4.2 レート制限
- [ ] スライディングウィンドウ実装
- [ ] IP別制限
- [ ] ウォレットアドレス別制限
- [ ] リソース別制限（追加提案）
- [ ] 制限違反時の適切な応答

### 4.3 監査・ログ
- [ ] 決済監査ログ実装
- [ ] セキュリティイベントログ
- [ ] 構造化ログ（JSON）
- [ ] ログローテーション設定

## フェーズ5: API実装

### 5.1 保護エンドポイント
- [x] GET /api/premium（デモ用）
- [x] ミドルウェア適用
- [x] 価格設定機能
- [x] 通貨・ネットワーク設定

### 5.2 管理エンドポイント
- [ ] GET /healthz - ヘルスチェック
- [ ] GET /billing/export.csv - 会計エクスポート
- [ ] GET /metrics - Prometheus メトリクス
- [ ] POST /admin/refund - 返金機能（将来）

### 5.3 会計エクスポート
- [ ] CSV生成機能
- [ ] 期間フィルター
- [ ] 通貨別集計
- [ ] 円換算機能（為替レートAPI連携）
- [ ] ダウンロード認証

## フェーズ6: クライアント実装

### 6.1 Next.js Webアプリ
- [ ] Smart Wallet SDK統合
- [ ] x402クライアントライブラリ
- [ ] 402応答パース機能
- [ ] 支払いフロー UI
- [ ] デモページ作成

### 6.2 Smart Wallet連携
- [ ] Coinbase Smart Wallet設定
- [ ] Paymaster統合（ガスレス体験）
- [ ] ウォレット接続UI
- [ ] 支払い確認UI
- [ ] トランザクション履歴表示

### 6.3 エージェント対策
- [ ] 予算制限機能
- [ ] 許可ドメイン設定
- [ ] 使用量ダッシュボード
- [ ] アラート機能

## フェーズ7: テスト・品質保証

### 7.1 単体テスト
- [ ] ミドルウェア機能テスト
- [ ] 支払い検証テスト
- [ ] レート制限テスト
- [ ] セキュリティ機能テスト

### 7.2 統合テスト
- [ ] Facilitator連携テスト
- [ ] エンドツーエンドテスト
- [ ] Smart Wallet連携テスト
- [ ] 決済フローテスト

### 7.3 負荷・セキュリティテスト
- [ ] 負荷テスト（Apache Bench/k6）
- [ ] DDoS耐性テスト
- [ ] ペネトレーションテスト
- [ ] セキュリティスキャン

## フェーズ8: 監視・運用

### 8.1 監視設定
- [ ] OpenTelemetry設定
- [ ] Prometheus メトリクス
- [ ] Grafana ダッシュボード
- [ ] Sentry エラー監視

### 8.2 アラート設定
- [ ] 支払い失敗率アラート
- [ ] レスポンス時間アラート
- [ ] セキュリティイベントアラート
- [ ] システムリソースアラート

### 8.3 バックアップ・災害復旧
- [ ] データベースバックアップ
- [ ] 設定ファイルバックアップ
- [ ] 災害復旧手順書
- [ ] フェイルオーバーテスト

## フェーズ9: デプロイメント

### 9.1 ステージング環境
- [ ] Base Sepolia設定
- [ ] テスト用Facilitator設定
- [ ] CI/CD パイプライン
- [ ] 自動デプロイ設定

### 9.2 本番環境
- [ ] Base Mainnet切り替え
- [ ] 本番用Facilitator設定
- [ ] スケーリング設定
- [ ] セキュリティ強化

### 9.3 PaaS対応
- [ ] Vercel/Workers対応
- [ ] Neon/Upstash対応
- [ ] 環境変数管理
- [ ] デプロイ自動化

## フェーズ10: ドキュメント・保守

### 10.1 技術ドキュメント
- [ ] API仕様書（OpenAPI）
- [ ] ミドルウェア使用方法
- [ ] 設定ガイド
- [ ] トラブルシューティング

### 10.2 運用ドキュメント
- [ ] 運用マニュアル
- [ ] 監視ガイド
- [ ] インシデント対応手順
- [ ] セキュリティポリシー

### 10.3 ユーザードキュメント
- [ ] 導入ガイド
- [ ] SDK使用方法
- [ ] サンプルコード
- [ ] FAQ

## 受け入れ基準（Doneの定義）

### MVP要件
- [x] 保護ルートで 402 → 支払い → 200 + X-PAYMENT-RESPONSE が安定動作
- [x] **nonce検証問題の修正** - PaymentPayloadからnonceを正しく取得し検証が成功 (2025/10/01)
- [ ] レート制限・リプレイ防止が正常機能（nonce再利用・期限切れ・高頻度を拒否）
- [ ] 監査ログがCSVエクスポート可能、tx追跡が可能
- [ ] Base Sepolia→Base本番への切替がenv差替のみで完了

### 付加価値要件
- [ ] Smart Wallet + Paymasterでガスレス体験のデモが動作
- [ ] TypeScriptフルスタックでの統一開発環境
- [ ] モニタリング・アラートが適切に機能

## 優先度

**P0 (最優先)**: フェーズ1-5（基本機能）
**P1 (高優先)**: フェーズ6-7（クライアント・テスト）
**P2 (中優先)**: フェーズ8-9（運用・デプロイ）
**P3 (低優先)**: フェーズ10（ドキュメント）

## 🚀 実装方針 (2024年12月更新)

### 戦略的実装順序
**MVP思考に基づく段階的デプロイ戦略を採用**

#### Phase 1: セキュリティ基盤
- **フェーズ4.1: リプレイ防止強化** (30-45分)
  - nonce期限切れ自動削除
  - 重複チェック強化  
  - 期限切れ検証

#### Phase 2: フルスタック体験
- **フェーズ6: クライアント実装** (2-3時間)
  - Next.js Webアプリ
  - Smart Wallet SDK統合
  - 支払いフロー UI
  - ローカル環境での完全な支払い体験実現

#### Phase 3: ステージング検証
- **フェーズ9.1: ステージング環境** (1-2時間)
  - Base Sepolia設定
  - Azure環境構築
  - CI/CD パイプライン
  - 画面込みでの動作検証

#### Phase 4: セキュリティ評価・強化
- **セキュリティ評価フェーズ** (体験後に優先度決定)
  - フェーズ4.2: レート制限
  - フェーズ7.1: 単体テスト
  - フェーズ8.1: 監視設定
  - 実際の使用感から優先順位を再評価

#### Phase 5: 本番デプロイ
- **フェーズ9.2: 本番環境** (30分-1時間)
  - Base Mainnet切り替え
  - 本番用Facilitator設定
  - セキュリティ強化適用

### 方針の利点
1. **Early Validation**: 最小限の機能で価値を検証
2. **Risk Mitigation**: 段階的デプロイでリスク軽減
3. **Feedback Loop**: 実際の体験から次の優先度を決定
4. **MVP思考**: 機能豊富化より先に動作する製品を実現

### マイルストーン
- **M1 完了**: ローカル環境で完全な支払いフロー体験
- **M2 完了**: ステージング環境で画面込み動作確認
- **M3 完了**: セキュリティ評価に基づく強化実施
- **M4 完了**: 本番環境での安定運用開始

---
*最終更新: 2024年12月*
*プロジェクト: x402決済ミドルウェア* 